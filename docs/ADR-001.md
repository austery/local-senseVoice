---
specId: ADR-001
title: Local SenseVoice Service 架构原则
Date: 2025-11-22
Status: ✅ Accepted
Context: Mac mini M4 Pro (64GB), Python 3.10+, FastAPI
Goal: 构建一个 **Production-Ready** 但保持 **MVP** 规模的本地语音转录服务。
---

## 1. Context (背景)

我们需要在本地运行 FunASR (SenseVoiceSmall) 模型。面临的挑战包括：
- **Apple Silicon 限制**: M4 芯片的统一内存架构 (UMA) 不适合多进程并发争抢显存。
- **Python 的灵活性陷阱**: 容易写成难以维护的脚本代码。
- **稳定性要求**: 服务需长期运行，不能因为一次推理失败就崩溃。

## 2. Decision (决策)

### 2.1 采用 Clean Architecture (简化版)

即使是 MVP，也要严守分层，拒绝“脚本式”写法。

```

┌──────────────────────────────────────┐
│  API Layer (FastAPI Routers)         │  ← **入口层**
│  (Handle HTTP, Validation)           │     只做参数校验，立即返回 Future
└───────────────┬──────────────────────┘
│
┌───────────────▼──────────────────────┐
│  Service Layer (Async Queue Manager) │  ← **调度层** (核心)
│  (QueueService, TranscriptionService)│     管理并发，决定"谁先跑"
└───────────────┬──────────────────────┘
│
┌───────────────▼──────────────────────┐
│  Engine Layer (Inference Core)       │  ← **业务核心** (单例)
│  (SenseVoiceEngine)                  │     纯粹的输入音频-\>输出文本
└───────────────┬──────────────────────┘
│
┌───────────────▼──────────────────────┐
│  Infrastructure / Adapters           │  ← **设施层**
│  (FunASR, FFmpeg, Loggers)           │     具体库的调用细节
└──────────────────────────────────────┘

```

### 2.2 核心约束 (Critical Constraints)

1.  **严格串行 (Strict Serial Execution)**:
    - **原因**: 针对 M4 Pro 优化。SenseVoice 推理极快，并发会导致 MPS 图编译抖动和显存争抢。
    - **实现**: 使用**单消费者 (Single Consumer)** 模式的 `asyncio.Queue`。禁止开启多线程推理。

2.  **类型优先 (Type-First)**:
    - **原因**: Python 动态类型难以维护。
    - **实现**: 所有数据交换必须通过 **Pydantic Models** (`schemas.py`)。禁止传递裸 `dict` 或 `tuple`。

3.  **单例生命周期 (Singleton Lifecycle)**:
    - **原因**: 模型加载耗时且占内存。
    - **实现**: `SenseVoiceEngine` 必须作为单例在 `Lifespan` (App Startup) 中初始化。

---

## 3. Consequences (后果)

- **优点**: 结构极其清晰，测试容易（Mock Engine 层即可测 API），完全杜绝了 OOM (内存溢出) 风险。
- **缺点**: 代码量比“脚本版”多出 30%，但这是为了“十分钟生成，零调试”所付出的必要成本。
